---
# NthLayer Deployment Gate - ArgoCD PreSync Hook
#
# This Job runs before ArgoCD syncs your application.
# If the error budget check fails (exit code 2), the sync is blocked.
#
# Usage:
# 1. Add this file to your application's manifests
# 2. Configure the ConfigMap with your service.yaml
# 3. Set PROMETHEUS_URL to your Prometheus endpoint

apiVersion: v1
kind: ConfigMap
metadata:
  name: nthlayer-service-config
  annotations:
    argocd.argoproj.io/hook: PreSync
data:
  service.yaml: |
    service:
      name: my-service
      team: platform
      tier: critical
      type: api

    resources:
      - kind: SLO
        name: availability
        spec:
          objective: 99.95
          window: 30d
          indicator:
            query: |
              sum(rate(http_requests_total{service="${service}",status!~"5.."}[5m]))
              /
              sum(rate(http_requests_total{service="${service}"}[5m]))

      - kind: DeploymentGate
        name: error-budget-gate
        spec:
          thresholds:
            warning: 20
            blocking: 10

---
apiVersion: batch/v1
kind: Job
metadata:
  name: nthlayer-deployment-gate
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  backoffLimit: 0  # Don't retry - fail fast
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: gate-check
          image: python:3.11-slim
          command:
            - /bin/bash
            - -c
            - |
              pip install --quiet nthlayer
              nthlayer check-deploy /config/service.yaml \
                --prometheus-url "$PROMETHEUS_URL" \
                --environment "$ENVIRONMENT"
          env:
            - name: PROMETHEUS_URL
              valueFrom:
                secretKeyRef:
                  name: prometheus-credentials
                  key: url
            - name: ENVIRONMENT
              value: "prod"
            # Optional: Prometheus auth
            - name: PROMETHEUS_USERNAME
              valueFrom:
                secretKeyRef:
                  name: prometheus-credentials
                  key: username
                  optional: true
            - name: PROMETHEUS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: prometheus-credentials
                  key: password
                  optional: true
          volumeMounts:
            - name: config
              mountPath: /config
      volumes:
        - name: config
          configMap:
            name: nthlayer-service-config

---
# Secret for Prometheus credentials (create separately)
# kubectl create secret generic prometheus-credentials \
#   --from-literal=url=https://prometheus.example.com \
#   --from-literal=username=admin \
#   --from-literal=password=secret
